\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ulthiel}[2024/04/09 Base package by Ulrich Thiel]

%===============================================================================
% Package options
%===============================================================================
% bibtex: loads bibtex
\newif\if@bibtex\@bibtexfalse
\DeclareOption{bibtex}{
  \@bibtextrue
}

% apa: sets bibtex style from numeric (default) to apa
\newif\if@apa\@apafalse
\DeclareOption{apa}{
  \@apatrue
}

% ger: sets German language
\newif\if@german\@germanfalse
\DeclareOption{german}{
  \@germantrue
}

% sansserif: sets font to sans serif font
\newif\if@sansserif\@sansseriffalse
\DeclareOption{sansserif}{
  \@sansseriftrue
}

% Julia code environment
\newif\if@julia\@juliafalse
\DeclareOption{julia}{
  \@juliatrue
}

% Process all options
\ProcessOptions

%===============================================================================
% Basic packages (do not change order!)
%===============================================================================

% inputenc allows the user to input accented characters directly from the
% keyboard. The community has changed its default encoding to UTF-8 as of April
% 2018, so the following can actually be omitted, since it does basically
% nothing.
% https://tex.stackexchange.com/questions/370278/is-there-any-reason-to-use-inputenc
% https://ctan.org/pkg/inputenc?lang=en
\RequirePackage[utf8]{inputenc}


% The package is an extension of cmap with improved flexibility and coverage,
% including the ability to re-encode Knuth’s basic mathematics fonts. The cmap
% package provides character map tables, which make PDF files generated by
% pdfLATEX both searchable and copy-able in acrobat reader and other compliant
% PDF viewers. https://ctan.org/pkg/mmap?lang=en
\RequirePackage[noTeX]{mmap}

% https://ctan.org/pkg/fontenc?lang=en
\RequirePackage[T1]{fontenc}

% This package manages culturally-determined typographical (and other) rules for
% a wide range of languages. https://ctan.org/pkg/babel?lang=en
\RequirePackage[ngerman, american]{babel}

\usepackage{amssymb}

% For mathscr letters
\usepackage{mathrsfs}

% Mathtools provides a series of packages designed to enhance the appearance of
% documents containing a lot of mathematics. The main backbone is amsmath [...]
% https://ctan.org/pkg/mathtools?lang=en
\RequirePackage{mathtools}

% https://ctan.org/pkg/url?lang=en
\RequirePackage[hyphens]{url}
\urlstyle{same}

% The general-purpose drawing package TiKZ can be used to typeset commutative
% diagrams and other kinds of mathematical pictures, generating high-quality
% results. The purpose of this package is to make the process of creation of
% such diagrams easier by providing a convenient set of macros and reasonable
% default settings. https://ctan.org/pkg/tikz-cd?lang=en
\RequirePackage{tikz-cd}
\usetikzlibrary{babel}

% Subliminal refinements towards typographical perfection
% https://ctan.org/pkg/microtype?lang=en
\RequirePackage[protrusion=true,expansion=true,babel=true,final]{microtype}

% The todonotes package allows you to insert to–do items in your document.
% http://tug.ctan.org/macros/latex/contrib/todonotes/todonotes.pdf
\RequirePackage[textsize=footnotesize]{todonotes}

% The package facilitates the kind of theorem setup typically needed in American
% Mathematical Society publications. https://ctan.org/pkg/amsthm?lang=en
\RequirePackage{amsthm}

% The hyperref package is used to handle cross-referencing commands in LATEX to
% produce hypertext links in the document. https://ctan.org/pkg/hyperref?lang=en
\PassOptionsToPackage{pdftex,unicode,pdfusetitle}{hyperref}
\@ifpackageloaded{hyperref}{}{\RequirePackage{hyperref}}

% This package introduces aliases for counters.
% https://ctan.org/pkg/aliascnt?lang=en Note we introduce a fix \Autoref{}
% below.
\RequirePackage{aliascnt}

% This package provides advanced facilities for inline and display quotations.
% https://ctan.org/pkg/csquotes?lang=en
\RequirePackage{csquotes}

%===============================================================================
% Basic document settings
%===============================================================================
\frenchspacing
\raggedbottom
\setlength{\belowcaptionskip}{0pt}

%===============================================================================
% Handling for different document classes
%===============================================================================
\@ifclassloaded{article}
{
    % The package redefines the \author command to work as normal or to allow a
    % footnote style of author/affiliation input.
    % https://ctan.org/pkg/authblk?lang=en
    \RequirePackage{authblk}

    \RequirePackage[a4paper, margin=3cm,]{geometry}
}{}

\@ifclassloaded{amsart}
{
    % Puts author address in footer on first page
    % https://ctan.org/pkg/amsaddr?lang=de
    \RequirePackage[foot]{amsaddr}
}{}

%===============================================================================
% German
%===============================================================================
\if@german
	\AtBeginDocument{%
		\selectlanguage{ngerman}
	}
\fi

%===============================================================================
% Theorem environments
%===============================================================================
\numberwithin{equation}{section}

% Theorem style
\newtheorem{theorem}{Theorem}[section]

\providecommand*{\thmautorefname}{Theorem}

\newaliascnt{proposition}{theorem}
\newtheorem{proposition}[proposition]{Proposition}
\aliascntresetthe{proposition}
\providecommand*{\propositionautorefname}{Proposition}

\newaliascnt{lemma}{theorem}
\newtheorem{lemma}[lemma]{Lemma}
\aliascntresetthe{lemma}
\providecommand*{\lemmaautorefname}{Lemma}

\newaliascnt{corollary}{theorem}
\newtheorem{corollary}[corollary]{Corollary}
\aliascntresetthe{corollary}
\providecommand*{\corollaryautorefname}{Corollary}

% Definition style
\theoremstyle{definition}

\newaliascnt{definition}{theorem}
\newtheorem{definition}[definition]{Definition}
\aliascntresetthe{definition}
\providecommand*{\definitionautorefname}{Definition}

\newaliascnt{example}{theorem}
\newtheorem{example}[example]{Example}
\aliascntresetthe{example}
\providecommand*{\exampleautorefname}{Example}

\newaliascnt{exercise}{theorem}
\newtheorem{exercise}[exercise]{Exercise}
\aliascntresetthe{exercise}
\providecommand*{\exerciseautorefname}{Exercise}

% Remark style
\theoremstyle{remark}

\newaliascnt{remark}{theorem}
\newtheorem{remark}[remark]{Remark}
\aliascntresetthe{remark}
\providecommand*{\remarkautorefname}{Remark}

\newaliascnt{caution}{theorem}
\newtheorem{caution}[caution]{Caution}
\aliascntresetthe{caution}
\providecommand*{\cautionautorefname}{Caution}

\newaliascnt{assumption}{theorem}
\newtheorem{assumption}[assumption]{Assumption}
\aliascntresetthe{assumption}
\providecommand*{\assumptionautorefname}{Assumption}

% Autoref for sections
\AtBeginDocument{%
\renewcommand{\chapterautorefname}{Chapter}
\renewcommand{\sectionautorefname}{Section}
\renewcommand{\subsectionautorefname}{Section}
}

%===============================================================================
% autoref modification adding plurals and avoiding colored environment name.
% Modified from
% https://tex.stackexchange.com/questions/15728/multiple-references-with-autoref
%===============================================================================

% define a macro \Autoref to allow multiple references to be passed to \autoref
\newcommand\Autoref[1]{\@first@ref#1,@}
\def\@throw@dot#1.#2@{#1}% discard everything after the dot
\def\@set@refname#1{%    % set \@refname to autoefname+s using \getrefbykeydefault
    \edef\@tmp{\getrefbykeydefault{#1}{anchor}{}}%
    \xdef\@tmp{\expandafter\@throw@dot\@tmp.@}%
    \ltx@IfUndefined{\@tmp autorefnameplural}%
         {\def\@refname{\@nameuse{\@tmp autorefname}s}}%
         {\def\@refname{\@nameuse{\@tmp autorefnameplural}}}%
}
\def\@first@ref#1,#2{%
  \ifx#2@%
		\edef\@tmp{\getrefbykeydefault{#1}{anchor}{}}%
		\xdef\@tmp{\expandafter\@throw@dot\@tmp.@}%
		\def\@refname{\@nameuse{\@tmp autorefname}}%
		\@refname~\ref{#1}%
		\let\@nextref\@gobble% only one ref, revert to normal \autoref
  \else%
		\edef\@tmp{\getrefbykeydefault{#1}{anchor}{}}%
		\xdef\@tmp{\expandafter\@throw@dot\@tmp.@}%
		\ltx@IfUndefined{\@tmp autorefnameplural}%
				 {\def\@refname{\@nameuse{\@tmp autorefname}s}}%
				 {\def\@refname{\@nameuse{\@tmp autorefnameplural}}}%
    \@refname~\ref{#1}% add autorefname and first reference
    \let\@nextref\@next@ref% push processing to \@next@ref
  \fi%
  \@nextref#2%
}
\def\@next@ref#1,#2{%
   \ifx#2@ and~\ref{#1}\let\@nextref\@gobble% at end: print and+\ref and stop
   \else, \ref{#1}% print  ,+\ref and continue
   \fi%
   \@nextref#2%
}

%===============================================================================
% Bibtex
% Note: the biblatex-apa style needs a recent TeXLive (2023).
%===============================================================================
\if@bibtex

  \if@apa
    \RequirePackage[backend=biber,style=apa,autocite=inline]{biblatex}
  \else
    \RequirePackage[backend=biber,style=numeric,sorting=nyt,autocite=inline,isbn=false,maxbibnames=99, maxnames=99, maxcitenames=99]{biblatex}
  \fi

  \addbibresource{references.bib}

  \renewcommand*{\bibfont}{\footnotesize}

  \AtEndDocument{
    \printbibliography
  }

\fi

%===============================================================================
% Sans serif font
%===============================================================================
\if@sansserif
  \RequirePackage{paratype}
  \renewcommand*\familydefault{\sfdefault}
  %\setlength{\parindent}{0pt}
  \RequirePackage[onlymath]{sansmathfonts}
\fi

%===============================================================================
% Julia code environment
%===============================================================================
\if@julia
  \RequirePackage[breakable]{tcolorbox}

  % Listings
  \RequirePackage{listings}

  % Nice mono font
  \RequirePackage[scaled=0.8]{DejaVuSansMono}

  % Julia environment
  \definecolor{juliacomment}{gray}{0.46}
  \definecolor{juliadelim}{RGB}{48, 110, 28}
  \definecolor{juliastring}{RGB}{124, 22, 14}

  \lstdefinelanguage{Julia}%
    {morecomment=[l]\#,%
    morecomment=[n]{\#=}{=\#},%
    moredelim=[s][\color{juliadelim}]{julia}{>}
  }[comments]%

  \lstdefinestyle{juliapromptstyle}{  
      language         = Julia,
      basicstyle       = \ttfamily\footnotesize,
      commentstyle     = \color{juliacomment},
      showstringspaces = false,
      breakatwhitespace=false,         
      breaklines=true,                                  
      keepspaces=true,                                           
      tabsize=2,
      aboveskip=0pt,
      belowskip=0pt,
      inputencoding=utf8,
      extendedchars=true,
      literate={⊕}{{$\oplus$}}1 {𝒞}{{$\mathscr{C}$}}1 {ℛ}{{$\mathscr{R}$}}1 {𝒵}{{$\mathscr{Z}$}}1 {₂}{{$_2$}}1
  }

  \lstnewenvironment{juliaprompt}{\lstset{style=juliapromptstyle}}{}

  % Tikz for Julia symbol
  \RequirePackage{tikz}
  \usetikzlibrary{positioning}
  \usetikzlibrary{calc}

  % Julia symbol
  \definecolor{julialightred}{RGB}{211,79,73}
  \definecolor{juliadarkred}{RGB}{199,44,38}
  \definecolor{julialightgreen}{RGB}{78,153,67}
  \definecolor{juliadarkgreen}{RGB}{43,129,33}
  \definecolor{julialightpurple}{RGB}{150,107,178}
  \definecolor{juliadarkpurple}{RGB}{126,78,160}
  \definecolor{julialightblue}{RGB}{49,101,205}
  \definecolor{juliadarkblue}{RGB}{20,92,205}

  \tikzset{
    juliadot/.style args={#1,#2}{shape=circle,line width=0.03ex,minimum width=0.4ex,fill=#1,draw=#2}
  }

  \newcommand\julialetter[1]{{\strut\fontfamily{cmss}\bfseries\selectfont{#1}}}

  \DeclareRobustCommand\juliasymbol{%
  \begin{tikzpicture}[baseline=0mm, every node/.style={inner sep=0mm, outer sep=0mm}]
  \node[anchor=base]        (j) at (0,0) {\julialetter{\j}};
  \node[anchor=base, right=0ex of j] (u) {\julialetter{u}};
  \node[anchor=base, right=0ex of u] (l) {\julialetter{l}};
  \node[anchor=base, right=0ex of l] (i) {\julialetter{\i}};
  \node[anchor=base, right=0ex of i] (a) {\julialetter{a}};
  \path let \p1 = (j) in node[juliadot={julialightblue,juliadarkblue}] (bluedot) at (\x1+0.02ex,1.4ex) {};
  \path let \p1 = (i) in node[juliadot={julialightred,juliadarkred}] (reddot) at (\x1,1.4ex) {};
  \path let \p1 = (reddot) in node[juliadot={julialightpurple,juliadarkpurple}] (purpledot) at (\x1+0.5ex,\y1) {};
  \path let \p1 = (reddot) in node[juliadot={julialightgreen,juliadarkgreen}] (greendot) at (\x1+0.25ex,\y1+0.42ex) {};
  \end{tikzpicture}%
  }

\fi


%==============================================================================
% Category command:
% \cat{Mod}{A}{B} is A-Mod-B
% \cat{Mod}{A}{} is A-Mod
% \cat{Mod}{}{B} is Mod-B
%==============================================================================
\RequirePackage{xparse}
\ExplSyntaxOn
\DeclareExpandableDocumentCommand{\IfNoValueOrEmptyTF}{mmm}
 {
  \IfNoValueTF{#1}{#2}
   {
    \tl_if_empty:nTF {#1} {#2} {#3}
   }
 }
\ExplSyntaxOff
\DeclareDocumentCommand{\cat}{m g g}
{
    \IfNoValueOrEmptyTF{#2}
    {
        \IfNoValueOrEmptyTF{#3}
        {
            \mathsf{#1}
        }
        {
            \ensuremath{\mathsf{#1}\text{-}{#3}}
        }
    }
    {
        \IfNoValueOrEmptyTF{#3}
        {
            \ensuremath{{#2}\text{-}\mathsf{#1}}
        }
        {
            \ensuremath{{#2}\text{-}\mathsf{#1}\text{-}{#3}}
        }
    }
}

%======================================================================
% Blind footnotes (without number)
% From https://tex.stackexchange.com/questions/326531/footnotes-fix-code
%======================================================================
\newcommand{\blfootnote}[1]{
  {\renewcommand{\thefootnote}{\roman{footnote}}\footnotetext[0]{#1}}
}

%======================================================================
% Fixed column width tables
%======================================================================
\RequirePackage{tabularx}
\RequirePackage{array}
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}


%==============================================================================
% Math operators
%==============================================================================
\DeclareMathOperator{\GL}{GL}
\DeclareMathOperator{\SO}{SO}
\DeclareMathOperator{\Sp}{Sp}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\SL}{SL}
\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\End}{End}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Ext}{Ext}
\DeclareMathOperator{\Ker}{Ker}
\DeclareMathOperator{\Coker}{Coker}
\DeclareMathOperator{\Image}{Im}
\DeclareMathOperator{\Cone}{Cone}
\DeclareMathOperator{\tr}{tr}
\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\Max}{Max}
\DeclareMathOperator{\Gal}{Gal}
\DeclareMathOperator{\Rad}{Rad}
\DeclareMathOperator{\Soc}{Soc}
\DeclareMathOperator{\Hd}{Hd}
\DeclareMathOperator{\Ann}{Ann}
\DeclareMathOperator{\Ass}{Ass}
\DeclareMathOperator{\Irr}{Irr}
\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\Mat}{Mat}
\DeclareMathOperator{\codim}{codim}
\DeclareMathOperator{\trdeg}{trdeg}

%==============================================================================
% Blackboard symbols
%==============================================================================
%\newcommand{\AA}{\mathbb{A}} %already defined...
\newcommand{\CC}{\mathbb{C}}
\newcommand{\FF}{\mathbb{F}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\PP}{\mathbb{P}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\kk}{\Bbbk}